# SensorComm-docker

**é«˜æ€§èƒ½ä¼ æ„Ÿå™¨æ•°æ®é€šä¿¡ç³»ç»Ÿ**

ä¸€ä¸ªåŸºäº C++ çš„è·¨å¹³å°ä¼ æ„Ÿå™¨æ•°æ®é‡‡é›†ä¸ä¼ è¾“ç³»ç»Ÿï¼Œä¸“æ³¨äºå®æ—¶è§†é¢‘æ•°æ®å¤„ç†å’Œå…±äº«å†…å­˜é€šä¿¡ã€‚

## ğŸš€ é¡¹ç›®ç®€ä»‹

SensorComm-docker æ˜¯ä¸€ä¸ªä¼ä¸šçº§çš„ä¼ æ„Ÿå™¨é€šä¿¡è§£å†³æ–¹æ¡ˆï¼Œé‡‡ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œé€šè¿‡å…±äº«å†…å­˜å®ç°é«˜æ•ˆçš„è§†é¢‘æ•°æ®ä¼ è¾“ã€‚ç³»ç»Ÿæ”¯æŒå¤šç§è§†é¢‘æ ¼å¼ï¼Œå…·æœ‰ä½å»¶è¿Ÿã€é«˜ååé‡çš„ç‰¹ç‚¹ï¼Œé€‚ç”¨äºå®æ—¶è§†é¢‘ç›‘æ§ã€è®¡ç®—æœºè§†è§‰åº”ç”¨å’Œå·¥ä¸šè‡ªåŠ¨åŒ–åœºæ™¯ã€‚

### æ ¸å¿ƒç‰¹æ€§

- ğŸ¥ **å¤šæ ¼å¼è§†é¢‘æ”¯æŒ**: æ”¯æŒ YUYVã€MJPEG ç­‰ä¸»æµæ ¼å¼
- âš¡ **ä½å»¶è¿Ÿä¼ è¾“**: åŸºäºå…±äº«å†…å­˜çš„é›¶æ‹·è´æ•°æ®ä¼ è¾“
- ğŸ”§ **V4L2 å…¼å®¹**: åŸç”Ÿæ”¯æŒ Linux V4L2 è§†é¢‘è®¾å¤‡
- ğŸ­ **å·¥å‚æ¨¡å¼è®¾è®¡**: çµæ´»çš„ç»„ä»¶åˆ›å»ºå’Œæ‰©å±•æœºåˆ¶
- ğŸ“Š **å®æ—¶ç›‘æ§**: å†…ç½®æ€§èƒ½ç›‘æ§å’Œ FPS ç»Ÿè®¡
- ğŸ›¡ï¸ **å¼‚å¸¸å®‰å…¨**: RAII èµ„æºç®¡ç†å’Œä¼˜é›…é”™è¯¯å¤„ç†
- ğŸ”„ **åŠ¨æ€æ ¼å¼åˆ‡æ¢**: è¿è¡Œæ—¶æ— ç¼åˆ‡æ¢è§†é¢‘æ ¼å¼

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å…±äº«å†…å­˜     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Producer      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Consumer      â”‚
â”‚                 â”‚                 â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                 â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ V4L2 Captureâ”‚ â”‚                 â”‚ â”‚GUI Display  â”‚ â”‚
â”‚ â”‚   Engine    â”‚ â”‚                 â”‚ â”‚   Engine    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                 â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Shared Memoryâ”‚ â”‚                 â”‚ â”‚Video Decoderâ”‚ â”‚
â”‚ â”‚  Manager    â”‚ â”‚                 â”‚ â”‚  (Factory)  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸»è¦ç»„ä»¶

- **ç”Ÿäº§è€…è¿›ç¨‹** (`producer_process`): ä» V4L2 è®¾å¤‡æ•è·è§†é¢‘æ•°æ®
- **æ¶ˆè´¹è€…è¿›ç¨‹** (`consumer_process/consumer_gui`): è¯»å–å¹¶æ˜¾ç¤ºè§†é¢‘æ•°æ®
- **å…±äº«å†…å­˜ç®¡ç†å™¨** (`ImageShmManager`): é«˜æ•ˆçš„å†…å­˜æ˜ å°„å’Œæ•°æ®ä¼ è¾“
- **æ ¼å¼è§£ç å™¨** (`YuyvDecoder`, `MjpgDecoder`): å¤šç§è§†é¢‘æ ¼å¼è§£ç æ”¯æŒ
- **é…ç½®ç®¡ç†å™¨** (`ConfigManager`): ç»Ÿä¸€çš„é…ç½®æ–‡ä»¶ç®¡ç†

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

### è¿è¡Œç¯å¢ƒ
- **æ“ä½œç³»ç»Ÿ**: Linux (Ubuntu 18.04+, CentOS 7+ æˆ–ç±»ä¼¼å‘è¡Œç‰ˆ)
- **ç¼–è¯‘å™¨**: GCC 7.0+ æˆ– Clang 6.0+ (æ”¯æŒ C++14)
- **å†…å­˜**: è‡³å°‘ 256MB å¯ç”¨å†…å­˜
- **ç¡¬ä»¶**: æ”¯æŒ V4L2 çš„è§†é¢‘è®¾å¤‡ (å¦‚ USB æ‘„åƒå¤´)

### ä¾èµ–åº“
- **OpenCV** (>= 4.0): å›¾åƒå¤„ç†å’Œæ˜¾ç¤º
- **nlohmann/json** (>= 3.7): JSON é…ç½®æ–‡ä»¶è§£æ
- **V4L2 å¼€å‘åº“**: Linux è§†é¢‘è®¾å¤‡æ¥å£
- **POSIX å…±äº«å†…å­˜**: ç³»ç»Ÿçº§ IPC æ”¯æŒ

## ğŸ› ï¸ ç¼–è¯‘å®‰è£…

### 1. å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/your-org/SensorComm-docker.git
cd SensorComm-docker
```

### 2. å®‰è£…ä¾èµ– (Ubuntu/Debian)
```bash
# å®‰è£…åŸºç¡€å¼€å‘å·¥å…·
sudo apt update
sudo apt install build-essential cmake pkg-config

# å®‰è£… OpenCV
sudo apt install libopencv-dev libopencv-contrib-dev

# å®‰è£… V4L2 å¼€å‘åº“
sudo apt install libv4l-dev v4l-utils

# éªŒè¯æ‘„åƒå¤´è®¾å¤‡
ls /dev/video*
v4l2-ctl --list-devices
```

### 3. ç¼–è¯‘é¡¹ç›®
```bash
cd src/cpp
make clean
make all

# ç¼–è¯‘æˆåŠŸåå¯æ‰§è¡Œæ–‡ä»¶å°†ä½äº:
# - build/bin/producer_process
# - build/bin/consumer_process  
# - build/bin/consumer_gui
```

### ç¼–è¯‘é€‰é¡¹
- `make debug`: ç¼–è¯‘è°ƒè¯•ç‰ˆæœ¬ (åŒ…å«è°ƒè¯•ç¬¦å·)
- `make release`: ç¼–è¯‘ä¼˜åŒ–ç‰ˆæœ¬ (ç”Ÿäº§ç¯å¢ƒ)
- `make clean`: æ¸…ç†ç¼–è¯‘æ–‡ä»¶

## âš™ï¸ é…ç½®è¯´æ˜

### è§†é¢‘é…ç½® (`config/videoConfig.json`)
```json
{
  "v4l2_capture": {
    "device_path": "/dev/video0",    // è§†é¢‘è®¾å¤‡è·¯å¾„
    "width": 1280,                   // è§†é¢‘å®½åº¦
    "height": 720,                   // è§†é¢‘é«˜åº¦  
    "format": "YUYV",               // åƒç´ æ ¼å¼ (YUYV/MJPG)
    "buffer_count": 4               // V4L2 ç¼“å†²åŒºæ•°é‡
  }
}
```

### å…±äº«å†…å­˜é…ç½® (`config/shmConfig.json`)
```json
{
  "shared_memory": {
    "name": "yuyv_shm",             // å…±äº«å†…å­˜åç§°
    "total_size_mb": 32,            // æ€»å†…å­˜å¤§å° (MB)
    "buffer_size_mb": 10,           // å•ä¸ªç¼“å†²åŒºå¤§å° (MB)
    "buffer_count": 3               // ç¼“å†²åŒºæ•°é‡
  }
}
```

### é…ç½®å‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ | æ¨èå€¼ |
|------|------|---------|
| `device_path` | V4L2è®¾å¤‡è·¯å¾„ | `/dev/video0` |
| `width/height` | è§†é¢‘åˆ†è¾¨ç‡ | `1280x720` (HD), `640x480` (VGA) |
| `format` | åƒç´ æ ¼å¼ | `YUYV` (æœªå‹ç¼©), `MJPG` (å‹ç¼©) |
| `total_size_mb` | å…±äº«å†…å­˜æ€»å¤§å° | 32MB (å¯æ ¹æ®åˆ†è¾¨ç‡è°ƒæ•´) |
| `buffer_count` | ç¯å½¢ç¼“å†²åŒºæ•°é‡ | 3-4 (å¹³è¡¡å»¶è¿Ÿå’Œç¨³å®šæ€§) |

## ğŸš€ ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¯åŠ¨

1. **å¯åŠ¨ç”Ÿäº§è€…è¿›ç¨‹** (åœ¨ç»ˆç«¯1ä¸­):
```bash
cd src/cpp/video
./build/bin/producer_process
```

2. **å¯åŠ¨æ¶ˆè´¹è€…GUI** (åœ¨ç»ˆç«¯2ä¸­):
```bash
cd src/cpp/video  
./build/bin/consumer_gui
```

### å‘½ä»¤è¡Œé€‰é¡¹
```bash
# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
./producer_process --video-config=/path/to/video.json --shm-config=/path/to/shm.json

# å¯ç”¨è¯¦ç»†æ—¥å¿—
./consumer_gui --verbose --log-fps

# ä¿å­˜è§†é¢‘å¸§åˆ°æ–‡ä»¶
./consumer_process --save-frames --max-frames=100
```

### æµ‹è¯•å’Œè¯Šæ–­

è¿è¡Œè®¾å¤‡å…¼å®¹æ€§æµ‹è¯•:
```bash
cd src/cpp/video/test
chmod +x test_video.sh
./test_video.sh
```

è¯¥è„šæœ¬å°†æ£€æŸ¥:
- æ‘„åƒå¤´è®¾å¤‡å¯ç”¨æ€§
- æ”¯æŒçš„è§†é¢‘æ ¼å¼å’Œåˆ†è¾¨ç‡
- USB æ€»çº¿å¸¦å®½å’Œæ€§èƒ½
- ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### ç³»ç»Ÿè°ƒä¼˜å»ºè®®

1. **å†…å­˜ä¼˜åŒ–**:
   ```bash
   # å¢åŠ å…±äº«å†…å­˜é™åˆ¶
   echo 'kernel.shmmax = 134217728' >> /etc/sysctl.conf  # 128MB
   echo 'kernel.shmall = 32768' >> /etc/sysctl.conf
   sysctl -p
   ```

2. **USB è®¾å¤‡ä¼˜åŒ–**:
   ```bash
   # å¢åŠ  USB ç¼“å†²åŒºå¤§å°
   echo 16 > /sys/module/usbcore/parameters/usbfs_memory_mb
   ```

3. **å®æ—¶ä¼˜å…ˆçº§** (å¯é€‰):
   ```bash
   # ä»¥æ›´é«˜ä¼˜å…ˆçº§è¿è¡Œ
   sudo nice -n -10 ./producer_process
   ```

### æ€§èƒ½ç›‘æ§

ç³»ç»Ÿæä¾›å®æ—¶æ€§èƒ½ç»Ÿè®¡:
- **FPS (å¸§ç‡)**: æ¯2ç§’è¾“å‡ºå½“å‰æ•è·/æ˜¾ç¤ºå¸§ç‡
- **å»¶è¿Ÿç›‘æ§**: å¸§æ—¶é—´æˆ³è·Ÿè¸ªå’Œå»¶è¿Ÿè®¡ç®—
- **å†…å­˜ä½¿ç”¨**: å…±äº«å†…å­˜ç¼“å†²åŒºåˆ©ç”¨ç‡

## ğŸ”§ å¼€å‘æŒ‡å—

### ä»£ç ç»“æ„
```
src/cpp/
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ ipc/              # è¿›ç¨‹é—´é€šä¿¡ (å…±äº«å†…å­˜)
â”‚   â””â”€â”€ json/             # JSON è§£æåº“
â”œâ”€â”€ config/               # é…ç½®ç®¡ç†å’Œå·¥å‚æ¨¡å¼
â”œâ”€â”€ video/
â”‚   â”œâ”€â”€ formats/          # è§†é¢‘æ ¼å¼å¤„ç† (æ•è·/è§£ç )
â”‚   â”œâ”€â”€ test/            # æµ‹è¯•ç¨‹åº
â”‚   â””â”€â”€ *.cpp            # ä¸»è¦ä¸šåŠ¡é€»è¾‘
â””â”€â”€ Makefile
```

### æ‰©å±•æ–°æ ¼å¼

1. **æ·»åŠ æ–°çš„è§£ç å™¨**:
```cpp
// ç»§æ‰¿ IDecoder æ¥å£
class H264Decoder : public IDecoder {
public:
    cv::Mat decode(const uint8_t* data, const ImageHeader& header) override;
};
```

2. **åœ¨å·¥å‚ä¸­æ³¨å†Œ**:
```cpp
// factory.cpp
case ImageFormat::H264:
    return std::make_unique<H264Decoder>();
```

### æ·»åŠ æ–°çš„æ•è·æº

1. **å®ç° ICapture æ¥å£**:
```cpp
class NetworkCapture : public ICapture {
    void start() override;
    void stop() override;
    bool capture(CapturedFrame& frame, std::atomic<bool>& running) override;
};
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: æ‰¾ä¸åˆ°æ‘„åƒå¤´è®¾å¤‡**
```bash
# æ£€æŸ¥è®¾å¤‡æƒé™
ls -l /dev/video*
sudo chmod 666 /dev/video0

# æ£€æŸ¥è®¾å¤‡æ˜¯å¦è¢«å ç”¨
lsof /dev/video0
```

**Q: å…±äº«å†…å­˜åˆ›å»ºå¤±è´¥**
```bash
# æ£€æŸ¥å…±äº«å†…å­˜é™åˆ¶
ipcs -m
# æ¸…ç†æ®‹ç•™çš„å…±äº«å†…å­˜
ipcrm -M <key>
```

**Q: ç¼–è¯‘é”™è¯¯**
```bash
# ç¡®ä¿å®‰è£…äº†æ‰€æœ‰ä¾èµ–
pkg-config --libs opencv4
# æ£€æŸ¥ç¼–è¯‘å™¨ç‰ˆæœ¬
gcc --version
```

**Q: è§†é¢‘å¸§ç‡è¿‡ä½**
- é™ä½åˆ†è¾¨ç‡ (å¦‚ä» 1280x720 åˆ° 640x480)
- æ£€æŸ¥ USB æ€»çº¿å¸¦å®½ (`lsusb -t`)
- å¢åŠ ç¼“å†²åŒºæ•°é‡
- ç¡®ä¿ CPU è´Ÿè½½ä¸è¿‡é«˜
- æ›´æ¢å›¾ç‰‡æ ¼å¼

### æ—¥å¿—åˆ†æ

ç³»ç»Ÿæ—¥å¿—å…³é”®ä¿¡æ¯:
```
Producer: Started capture stream.          # æ•è·å¯åŠ¨æˆåŠŸ
Producer: FPS: 29.5, Frames: 590          # æ€§èƒ½ç»Ÿè®¡
ConsumerGUI: Format changed from 0 to 1    # åŠ¨æ€æ ¼å¼åˆ‡æ¢
ConsumerGUI: Display FPS: 30.0             # æ˜¾ç¤ºå¸§ç‡
```


### ä»£ç è§„èŒƒ
- éµå¾ª Google C++ é£æ ¼æŒ‡å—
- ä½¿ç”¨ Doxygen æ ¼å¼æ³¨é‡Š
- ç¡®ä¿é€šè¿‡æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹

