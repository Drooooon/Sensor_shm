# ==========================================================
#         src/cpp/Makefile (æœ€ç»ˆé“¾æ¥ä¿®æ­£ç‰ˆ)
# ==========================================================

CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -O3 -g -pthread

# --- 1. è·¯å¾„å’Œç›®å½•å®šä¹‰ ---
BUILD_DIR = video/build
OBJ_DIR = $(BUILD_DIR)/obj
BIN_DIR = $(BUILD_DIR)/bin

# --- 2. å¤´æ–‡ä»¶å’Œé“¾æ¥åº“ ---
INCLUDES = -I.
INCLUDES += $(shell pkg-config --cflags opencv4)
LIBS = $(shell pkg-config --libs opencv4) -lrt

# --- 3. æºæ–‡ä»¶åˆ—è¡¨ (æ˜ç¡®åˆ†ç¦»åº“å’Œåº”ç”¨) ---
# a. åº“æ–‡ä»¶æºæ–‡ä»¶ (æ²¡æœ‰ main å‡½æ•°)
LIB_SRCS = \
    common/ipc/shm_manager.cpp \
    config/config_manager.cpp \
    video/image_shm_manager.cpp \
    video/formats/yuyv_processor.cpp

# b. ä¸»ç¨‹åºæºæ–‡ä»¶ (æ¯ä¸ªéƒ½æœ‰ main å‡½æ•°)
PRODUCER_APP_SRC = video/test/producer_process.cpp
CONSUMER_APP_SRC = video/test/consumer_process.cpp
CONSUMER_GUI_APP_SRC = video/test/consumer_gui.cpp

# --- 4. è‡ªåŠ¨åŒ–ç”Ÿæˆç›®æ ‡æ–‡ä»¶ (.o) ---
# $(notdir ...) åªå–æ–‡ä»¶å, $(...:.cpp=.o) æ›¿æ¢åç¼€
LIB_OBJS = $(addprefix $(OBJ_DIR)/, $(notdir $(LIB_SRCS:.cpp=.o)))

PRODUCER_OBJ = $(addprefix $(OBJ_DIR)/, $(notdir $(PRODUCER_APP_SRC:.cpp=.o)))
CONSUMER_OBJ = $(addprefix $(OBJ_DIR)/, $(notdir $(CONSUMER_APP_SRC:.cpp=.o)))
CONSUMER_GUI_OBJ = $(addprefix $(OBJ_DIR)/, $(notdir $(CONSUMER_GUI_APP_SRC:.cpp=.o)))

# --- 5. å®šä¹‰æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ç›®æ ‡ ---
PRODUCER_EXEC = $(BIN_DIR)/producer_process
CONSUMER_EXEC = $(BIN_DIR)/consumer_process
CONSUMER_GUI_EXEC = $(BIN_DIR)/consumer_gui
EXECS = $(PRODUCER_EXEC) $(CONSUMER_EXEC) $(CONSUMER_GUI_EXEC)

# --- 6. æ ¸å¿ƒæ„å»ºè§„åˆ™ ---
.PHONY: all clean run help

all: $(EXECS)

# *** å…³é”®ä¿®å¤ï¼šç²¾ç¡®çš„é“¾æ¥è§„åˆ™ ***
$(PRODUCER_EXEC): $(PRODUCER_OBJ) $(LIB_OBJS)
	@echo "Linking $@..."
	@mkdir -p $(@D)
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LIBS)
	@echo "âœ… Built executable: $@"

$(CONSUMER_EXEC): $(CONSUMER_OBJ) $(LIB_OBJS)
	@echo "Linking $@..."
	@mkdir -p $(@D)
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LIBS)
	@echo "âœ… Built executable: $@"

$(CONSUMER_GUI_EXEC): $(CONSUMER_GUI_OBJ) $(LIB_OBJS)
	@echo "Linking $@..."
	@mkdir -p $(@D)
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LIBS)
	@echo "âœ… Built executable: $@"

# é€šç”¨ç¼–è¯‘è§„åˆ™
# vpath å‘Šè¯‰ make å»å“ªé‡Œå¯»æ‰¾æºæ–‡ä»¶
vpath %.cpp common/ipc config video video/formats video/test

$(OBJ_DIR)/%.o: %.cpp
	@echo "Compiling $<..."
	@mkdir -p $(@D)
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# --- 7. è¿è¡Œã€æ¸…ç†å’Œå¸®åŠ© ---
run: all
	@echo "Running test script..."
	./video/test/test_streaming.sh

clean:
	@echo "Cleaning build artifacts..."
	@rm -rf $(BUILD_DIR)
	@echo "âœ… Clean completed"

help:
	@echo "ğŸš€ SensorComm C++ Build System"
	@echo "==============================="
	@echo "This Makefile is run from the 'src/cpp/' directory."
	@echo ""
	@echo "Usage:"
	@echo "  make        - Build all executables defined in '$(APP_DIR)'"
	@echo "  make run    - Build all and then run the main test script"
	@echo "  make clean  - Remove the entire build directory ('$(BUILD_DIR)')"
	@echo ""
	@echo "Detected Executables to be built:"
	@echo "  $(notdir $(EXECS))"
	@echo ""
	@echo "Output location:"
	@echo "  Executables: $(BIN_DIR)"
	@echo "  Object files: $(OBJ_DIR)"